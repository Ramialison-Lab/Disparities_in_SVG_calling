---
title: "Run SPARK analysis on scanpy processed FFPE prostate data"
author: Natalie Charitakis
---

```{r}
dyn.load('/hpc/software/installed/hdf5/1.10.5/lib/libhdf5_hl.so.100')
library(Seurat)
library(SeuratData)
library(ggplot2)
library(patchwork)
library(dplyr)
library(SPARK)
```

##Read in csv files
```{r}
obs <- read.csv('obs.csv')
var <- read.csv('var.csv')
X <- read.csv('X.csv', header=FALSE)
#delete first row of X dataframe
#colnames(X) <- NULL
X <- t(X)
#Add in numbers of names for the spot
colnames(X) <- 0:3568
```
##Generate metadata object to feed into Seurat object
```{r}
#get fake cell barcodes
cell_barcodes <- colnames(X)

#need get list of Orig.ident
orig.ident <- replicate(3569, "ffpe_prostate_cancer")

#get number of counts per cell
nCounts <- obs["n_counts"]

#get nFeature
nFeatures <- obs["n_genes"]

#% MT
percent.mt <- obs["pct_counts_mt"]

#only extract clusters once as this will be populated twice in metadata
seurat_clusters <- obs["clusters"]

metadata <- data.frame(orig.ident, nCounts,nFeatures, percent.mt, seurat_clusters)
rownames(metadata) <- cell_barcodes
colnames(metadata) <- c("orig.ident", "nCount_RNA","nFeature_RNA","percent.mt","seurat_clusters")
metadata
```

#Now try creating Seurat object
```{r}
ffpe_prostate_cancer <- CreateSeuratObject(X,
  project = "CreateSeuratObject",
  assay = "RNA",
  names.field = 1,
  meta.data = metadata,
)

#add active assay
ffpe_prostate_cancer@active.assay <- c("RNA")
```

#get spatial coordinates
```{r}
#load in tissue position list
tissue_coordinates <- read.csv('FFPE_Visium_Human_ProstateCancer/spatial/tissue_positions_list.csv',header=FALSE)
colnames(tissue_coordinates) <- c("barcode","tissue","row","col","imagerow","imagecol")
tissue_coordinates

##sort tissue coordinates df by obs barcodes
sorted_barcodes <- obs$X

tissue_coordinates <- tissue_coordinates[match(sorted_barcodes, tissue_coordinates$barcode), ]
rownames(tissue_coordinates) <- tissue_coordinates$barcode
tissue_coordinates = subset(tissue_coordinates, select = -c(barcode)) 
tissue_coordinates

#create scale factors object to add
spot = 188.5979256687412
fiducial = 304.6581876187358
hires = 0.07277491
lowres = 0.021832472
scale_factors <- Seurat::scalefactors(spot=spot,fiducial = fiducial,hires = hires,lowres = lowres)

##add coordinates and name of assay
ffpe_prostate_cancer@images$slice.1 = new(Class="VisiumV1",assay="RNA",key="image_",coordinates=tissue_coordinates,scale.factors=scale_factors)
ffpe_prostate_cancer@images$slice.1@assay <- c("RNA")

```

##Load in same data from scanpy X file as scaled data
```{r}
ffpe_prostate_cancer@assays$RNA@scale.data <- X 
```

#Extract our data with barcodes and information
```{r}
coordinates <- ffpe_prostate_cancer@images$slice.1@coordinates
#Unsure is row and rol or imagerow and imagecol so try both
loc <- coordinates[, c("row","col")]
#change column names
colnames(loc) <- c("x","y")
loc <- as.matrix(loc)
```

#Extract and label counts data
```{r}
##Need count matrix
counts <- as.matrix(ffpe_prostate_cancer@assays$RNA@counts)
```

#Analyse the data with SPARK-X
```{r}
sparkX <- sparkx(counts,loc,numCores=1,option="mixture")
```

#Filter genes by combinedPval then adjusted Pval
```{r}
#these have the gene names and p values
res <- sparkX$res_mtest

#first sort by combined pvalue
res <-  res[order(res$combinedPval),]

#cut off al genes with adjusted Pval > 0.05
sig_res <- res[res$adjustedPval <= 0.05,]
sig_res

#write this to file
write.csv(sig_res,'ffpe_prostate_spark_sig_SVGS_adj_pval.csv')
```