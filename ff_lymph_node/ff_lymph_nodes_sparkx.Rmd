---
title: "Run SPARK-X analysis on scanpy processed FF Lymph Node"
author: Natalie Charitakis
---

```{r}
dyn.load('/hpc/software/installed/hdf5/1.10.5/lib/libhdf5_hl.so.100')
library(Seurat)
library(SeuratData)
library(ggplot2)
library(patchwork)
library(dplyr)
library(SPARK)
```

##Read in csv files
```{r}
obs <- read.csv('obs.csv')
var <- read.csv('var.csv')
X <- read.csv('X.csv', header=FALSE)
X <- t(X)
#Add in numbers of names for the spot
colnames(X) <- 0:3781
```

##Generate metadata object to feed into Seurat object
```{r}
#get fake cell barcodes
cell_barcodes <- colnames(X)

#need get list of Orig.ident
orig.ident <- replicate(3782, "ff_lymph_nodes")

#get number of counts per cell
nCount_RNA <- obs["n_counts"]

#get nFeature - how does this not exist?!
nFeature_RNA <- obs["n_genes"]

#% MT
percent.mt <- obs["pct_counts_mt"]

#only extract clusters once as this will be populated twice in metadata
seurat_clusters <- obs["clusters"]

metadata <- data.frame(orig.ident, nCount_RNA,nFeature_RNA, percent.mt, seurat_clusters)
rownames(metadata) <- cell_barcodes
colnames(metadata) <- c("orig.ident", "nCount_RNA","nFeature_RNA","percent.mt","seurat_clusters")
metadata
```

#Now try creating Seurat object
```{r}
ff_lymph_nodes_seurat <- CreateSeuratObject(X,
  project = "CreateSeuratObject",
  assay = "RNA",
  names.field = 1,
  meta.data = metadata,
)

#add active assay
ff_lymph_nodes_seurat@active.assay <- c("RNA")
```

#get spatial coordinates
```{r}
#load in tissue position list
tissue_coordinates <- read.csv('V1_Human_Lymph_Node/spatial/tissue_positions_list.csv',header=FALSE)
colnames(tissue_coordinates) <- c("barcode","tissue","row","col","imagerow","imagecol")
tissue_coordinates

##sort tissue coordinates df by obs barcodes
sorted_barcodes <- obs$X

tissue_coordinates <- tissue_coordinates[match(sorted_barcodes, tissue_coordinates$barcode), ]
rownames(tissue_coordinates) <- tissue_coordinates$barcode
tissue_coordinates = subset(tissue_coordinates, select = -c(barcode)) 
tissue_coordinates

#create scale factors object to add
spot = 89.48996643177776
fiducial = 144.56071500517945
hires = 0.17011142
lowres = 0.051033426
scale_factors <- Seurat::scalefactors(spot=spot,fiducial = fiducial,hires = hires,lowres = lowres)

##add coordinates and name of assay
ff_lymph_nodes_seurat@images$slice.1 = new(Class="VisiumV1",assay="RNA",key="image_",coordinates=tissue_coordinates,scale.factors=scale_factors)
ff_lymph_nodes_seurat@images$slice.1@assay <- c("RNA")

```

##Load in same data from scanpy X file as scaled data
```{r}
ff_lymph_nodes_seurat@assays$RNA@scale.data <- X 
```

#Extract our data with barcodes and information
```{r}
coordinates <- ff_lymph_nodes_seurat@images$slice.1@coordinates
loc <- coordinates[, c("row","col")]
#change column names
colnames(loc) <- c("x","y")
loc <- as.matrix(loc)
```

#Extract and label counts data
```{r}
##Need count matrix
counts <- as.matrix(ff_lymph_nodes_seurat@assays$RNA@counts)
```

#Analyse the data with SPARK-X
```{r}
sparkX <- sparkx(counts,loc,numCores=1,option="mixture")
```

#Filter genes by combinedPval then adjusted Pval
```{r}
#these have the gene names and p values
res <- sparkX$res_mtest

#first sort by combined pvalue
res <-  res[order(res$combinedPval),]

#cut off al genes with adjusted Pval > 0.05
sig_res <- res[res$adjustedPval <= 0.05,]
sig_res

#write this to file
write.csv(sig_res,'ff_lymph_nodes_sparkx_sig_SVGS_adj_pval.csv')
```